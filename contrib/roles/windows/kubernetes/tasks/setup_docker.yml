---
- name: Docker network setup | Remove current default nat network win2016 v1709
  win_shell: |
    Get-HNSNetwork | Remove-HNSNetwork
  when: ansible_kernel == "10.0.16299.0"

- name: Docker network setup | Remove current default nat network win2016
  win_shell: |
    Get-ContainerNetwork | Remove-ContainerNetwork -Force
  when: ansible_kernel == "10.0.14393.0"

- name: Docker network setup | Create docker config
  win_lineinfile:
    path: C:\ProgramData\docker\config\daemon.json
    create: yes
    line: |
      { "bridge" : "none" }
    newline: unix

# Launch and do not wait for result, connection will drop
- name: Docker network setup | Create transparent network
  win_shell: |
    docker network create -d transparent --gateway {{OVN_GATEWAY_IP}} --subnet {{OVN_SUBNET}} -o com.docker.network.windowsshim.interface="{{ interface_name }}" {{ docker_info.docker_network_name }}
  async: 10
  poll: 0

# Wait for docker to create the HNS Network and the new adapter. Connection will
# drop shortly when doing this, wait for the connection to come back
- name: Docker network setup | Wait 15 seconds
  pause:
    seconds: 15
